events {
    worker_connections 1024;
}

http {
    # Docker internal DNS. Without an explicit resolver + variable-based proxy_pass,
    # nginx resolves service names only once at startup. If an upstream container
    # restarts and its IP changes, nginx can keep sending traffic to the stale IP
    # until nginx itself restarts.
    resolver 127.0.0.11 ipv6=off valid=10s;
    resolver_timeout 5s;

    server {
        listen 8088;

        location / {
            set $frontend_upstream frontend:8080;
            proxy_pass http://$frontend_upstream;
        }

        location /completion/ {
            set $completion_upstream completion:8000;
            rewrite ^/completion/(.*) /$1 break;
            proxy_pass http://$completion_upstream;
        }

        location /memento/ {
            set $memento_upstream memento:8005;
            rewrite ^/memento/(.*) /$1 break;
            proxy_pass http://$memento_upstream;
        }

        location /fcm/ {
            set $fcm_upstream fcm-service:8081;
            rewrite ^/fcm/(.*) /$1 break;
            proxy_pass http://$fcm_upstream;
        }

        # Email templates for Auth (GoTrue) - used for signup confirmation, password recovery, etc.
        location /auth-templates/ {
            alias /usr/share/nginx/auth-templates/;
            add_header Content-Type "text/html; charset=utf-8";
        }
    }
}